\subsection{Implementando traceroute}

Como dijimos anteriormente, \emph{traceroute} es una herramienta de dign\'ostico que se utiliza para hacer
un an\'alisis del estado de la conexi\'on entre 2 hosts comunicados a trav\'es del protocolo TCP/IP.
Este comando pone especial \'enfasis en los distintos tramos (determinados por los hops entre routers)
que va debe atravesar el paquete para llegar a destino.
Mediante este tipo de an\'alisis es posible obtener informaci\'on de gran inter\'es, como por
ejemplo identificar los enlaces con mayor RTT (determinantes en el c\'alculo del
RTT ''global'', entre el host origen y el destino). De esta manera es posible caracterizar los distintos
enlaces: RTT's altos pueden corresponderse a enlaces submarinos, o de reducida velocidad de transmisi\'on.

La idea b\'asica del algoritmo consiste en enviar paquetes con TTL's incrementales hacia el nodo destino
y obtener informaci\'on en funci\'on de los datagramas ICMP obtenidos, tal como muestra el siguiente
diagrama:

\begin{figure}[!h]
  \begin{center}
      \includegraphics[scale=0.4]{imagenes/traceroute.png}
      \caption{Mecanismo de acci\'on de traceroute}
      \label{fig:contra1}
  \end{center}
\end{figure}

Cada vez que un paquete es forwardeado hacia un router, el valor de su TTL se decrementa en una unidad.
Cuando un routers advierte que el TTL de un paquete ha alcanzado el valor 0, env\'ia un mensaje ICMP hacia
el host fuente del mensaje, de tipo ''time exceeded''. Conociendo la hora exacta de emisi\'on del paquete
original y hora en la cual arriba el mensaje de error es posible determinar el RTT entre el host en el cual se corre el algoritmo
y el router generador del paquete ICMP.
El algoritmo se extiende a cada uno de los nodos intermedios:
En la primera iteraci\'on se env\'ia un paquete con valor de TTL 1. Por lo tanto el router a 1 hop de
distancia env\'ia un mensaje de error, y el algoritmo puede calcular el RTT entre el origen y dicho
router.
Generalizando, en la iteraci\'on $i$ se env\'ia un paquete con valor de TTL $i$, y utilizando la informaci\'on
recibida, el algoritmo puede calcular el RTT entre el origen y el router ubicado a $i$ hops.
El algoritmo finaliza o bien cuando se recibe una respuesta afirmativa por parte del destino; o bien
cuando se alcanza el l\'imite de TTL permitido.

\subsubsection{Algunas consideraciones y detalles implementativos}

Para implementar el comando utilizamos la librer\'ia \emph{Scapy} de Python.

Traceroute por default env\'ia una secuencia de paquetes UDP hacia el nodo destino. Paquetes del estilo
TCP SYN tambi\'en pueden ser usados. En nuestra implementaci\'on la alternativa utilizada son los paquetes
ICMP de tipo ''echo request'' . Los mensajes recibidos ser\'an por lo tanto del tipo ''time exceeded''
para los nodos intermedios y ''echo reply'' cuando el paquete llega a destino.

La funci\'on debe recibir como argumentos el valor de TTL inicial con el que env\'ia el primer paquete
y el m\'aximo de saltos permitidos hasta alcanzar el destino. En nuestro caso utilizamos los valores
por defecto: 1 y 30 respectivamente.

Otro de los par\'ametros que debe especificarse es el n\'umero de reintentos que debe realizarse por cada
valor de TTL. ICMP, al igual que IP, es una capa ''sin garant\'ias'' en el env\'io de mensajes. Los routers
hacen el ''mejor esfuerzo'' para lograr el env\'io de los paquetes, pero no hay garant\'ias de que los mismos
alcancen el destino.
Teniendo esto en cuenta, es posible que los mensajes ICMP enviados por los routers no lleguen al emisor.
En dicho caso, es deseable que se realice m\'as de un intento para un determinado valor de TTL.
Usualmente la mayor\'ia de las implmentaciones utilizan 2 o 3 como valor. En nuestro caso decidimos
realizar 10 intentos por cada TTL. Este valor nos protege contra otro aspecto sensible del algoritmo,
descripto a continuaci\'on.

Un paquete no llega al mismo destino atravesando siempre las mismas rutas. Los nodos intermedios pueden
caerse o levantarse. Determinados enlaces pueden congestionarse o liberarse en distintos momentos.
Supongamos que el algoritmo env\'ia hacia el destino un paquete con TTL 10. ?`Qu\'e garant\'ias tenemos de que,
en caso de ser necesario un segundo intento porque no ha llegado ning\'un mensaje de error, el router
alcanzado luego del d\'ecimo hop sea el mismo? Ninguna. En otras palabras, dependiendo la ruta que siga
el datagrama, el router alcanzado luego del d\'ecimo hop ser\'a uno u otro.
Para tener cierto control respecto a esta situaci\'on, por cada valor de TTL se env\'ian 10 paquetes y
se guardan todas las direcciones de IP que han respondido los mensajes de error.
Luego, el algoritmo selecciona aquella direcci\'on que ha respondido m\'as veces.

Finalmente, el valor de RTT entre el host que corre el \emph{traceroute} y el router a $i$ hops de
distancia es calculado como el promedio de los valores obtenidos por cada intento.


\subsection{Estimando Enlaces Trasatl\'anticos}
Suponemos que el tiempo que le toma a un paquete ir de un nodo a otro 
por tierra es significativamente menor al que le toma atravesar un 
enlace trasatl\'antico. Por ello, calculamos la distancia en tiempo
que hay entre los pares de nodos vecinos y luego, asumiendo que los
mismos siguen una distribuci\'on normal, calculamos el estad\'istico
Zscore para cada uno de ellos. 

Finalmente fijaremos un umbral de Zscore para determinar qu\'e tramos
son submarinos. 
